---
- name: Update apt cache
  ansible.builtin.apt:
    update_cache: true
    cache_valid_time: 3600
  when: ansible_os_family == "Debian"

- name: Ensure sqlite is installed
  ansible.builtin.package:
    name: "{{ 'sqlite3' if ansible_os_family in ['Debian', 'Suse'] else 'sqlite' }}"
    state: present

- name: Ensure jq and curl are installed (for Discord notifications)
  ansible.builtin.package:
    name:
      - jq
      - curl
    state: present
  when: litedump_discord_webhook | length > 0

- name: Create backup directories
  ansible.builtin.file:
    path: "{{ item.dest }}"
    state: directory
    mode: "0750"
  loop: "{{ litedump_databases }}"

- name: Deploy backup script
  ansible.builtin.template:
    src: litedump.sh.j2
    dest: /usr/local/bin/litedump.sh
    mode: "0750"
  notify: Restart litedump timer

- name: Deploy systemd service
  ansible.builtin.template:
    src: litedump.service.j2
    dest: /etc/systemd/system/litedump.service
    mode: "0644"
  notify:
    - Reload systemd
    - Restart litedump timer

- name: Deploy systemd timer
  ansible.builtin.template:
    src: litedump.timer.j2
    dest: /etc/systemd/system/litedump.timer
    mode: "0644"
  notify:
    - Reload systemd
    - Restart litedump timer

- name: Enable and start litedump timer
  ansible.builtin.systemd_service:
    name: litedump.timer
    enabled: true
    state: started
    daemon_reload: true
